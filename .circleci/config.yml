version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:20.11

  docker-base:
    docker:
      - image: cimg/base:stable

commands:
  docker-login-ghcr:
    steps:
      - run:
          name: Login to GHCR
          command: |
            set -euo pipefail
            : "${GHCR_USERNAME:?Set GHCR_USERNAME in CircleCI project/env context}"
            : "${GHCR_TOKEN:?Set GHCR_TOKEN in CircleCI project/env context}"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

jobs:
  frontend_test:
    executor: node
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-v1-{{ checksum "package-lock.json" }}
            - npm-v1-
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Type check
          command: npx tsc --noEmit
      - save_cache:
          key: npm-v1-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

  frontend_release:
    executor: node
    steps:
      - checkout
      - run:
          name: Fetch git history & tags
          command: |
            set -euo pipefail
            git fetch --prune --unshallow || true
            git fetch --tags --force
      - run:
          name: Derive release tag from chart appVersion
          command: |
            set -euo pipefail

            # Source of truth for releases: Helm chart appVersion
            APP_VERSION="$(awk -F': *' '$1=="appVersion"{print $2}' charts/Chart.yaml | head -n 1 | tr -d '"' | tr -d "'")"
            if [ -z "$APP_VERSION" ]; then
              echo "Could not read appVersion from charts/Chart.yaml"
              exit 1
            fi

            RELEASE_TAG="v${APP_VERSION#v}"
            echo "Using release tag: $RELEASE_TAG"
            echo "RELEASE_TAG=$RELEASE_TAG" > /tmp/release.env
      - run:
          name: Create and push git tag
          command: |
            set -euo pipefail
            source /tmp/release.env

            git config user.name "circleci"
            git config user.email "circleci@users.noreply.github.com"

            if git rev-parse "refs/tags/$RELEASE_TAG" >/dev/null 2>&1; then
              TAG_SHA="$(git rev-list -n 1 "$RELEASE_TAG")"
              if [ "$TAG_SHA" = "$CIRCLE_SHA1" ]; then
                echo "Tag $RELEASE_TAG already exists on this commit; continuing."
              else
                echo "Tag $RELEASE_TAG already exists (points to $TAG_SHA)."
                echo "Bump charts/Chart.yaml appVersion to release a new version."
                exit 1
              fi
            else
              git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
              git push origin "$RELEASE_TAG"
            fi
      - persist_to_workspace:
          root: /tmp
          paths:
            - release.env

  frontend_build_and_push:
    executor: docker-base
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Check if a release was published
          command: |
            set -euo pipefail
            source /tmp/release.env
            if [ -z "${RELEASE_TAG:-}" ]; then
              echo "No release tag; skipping image build/push."
              circleci step halt
            fi
      - docker-login-ghcr
      - run:
          name: Build and push (multi-arch)
          command: |
            set -euo pipefail
            source /tmp/release.env
            SHORT_SHA="${CIRCLE_SHA1:0:12}"

            docker run --privileged --rm tonistiigi/binfmt --install all
            docker buildx create --use

            OWNER="${GHCR_OWNER:-$CIRCLE_PROJECT_USERNAME}"
            IMAGE="ghcr.io/${OWNER}/leapmailr-ui"
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --build-arg NODE_VERSION=20 \
              --build-arg NEXT_PUBLIC_API_URL="${NEXT_PUBLIC_API_URL:-http://localhost:8080/api/v1}" \
              -t "$IMAGE:$RELEASE_TAG" \
              -t "$IMAGE:sha-$SHORT_SHA" \
              --push \
              .

workflows:
  version: 2

  pr:
    jobs:
      - frontend_test:
          filters:
            branches:
              ignore: main

  main:
    jobs:
      - frontend_test:
          filters:
            branches:
              only: main
      - frontend_release:
          requires:
            - frontend_test
          filters:
            branches:
              only: main
      - frontend_build_and_push:
          requires:
            - frontend_release
          filters:
            branches:
              only: main
